<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СИНТЕЗ - Хімічна Стратегія</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #e8e8e8;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, arrayUnion, runTransaction } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            Atom, FlaskConical, Users, Copy, Check, AlertTriangle, 
            ArrowRightLeft, Play, Crown, LogOut, Loader2, X, RefreshCcw, LayoutGrid, Trash2, ClipboardCopy, Layers
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- ІНІЦІАЛІЗАЦІЯ FIREBASE (Автоматична) ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-synthesis-game';

        // --- КОНСТАНТИ ГРИ ---
        const ELEMENTS = {
            'H':  { m: 1,  name: 'Гідроген', color: 'bg-blue-100 text-blue-900 border-blue-300' },
            'O':  { m: 16, name: 'Оксиген',  color: 'bg-red-100 text-red-900 border-red-300' },
            'C':  { m: 12, name: 'Карбон',   color: 'bg-gray-200 text-gray-900 border-gray-400' },
            'N':  { m: 14, name: 'Нітроген', color: 'bg-indigo-100 text-indigo-900 border-indigo-300' },
            'Na': { m: 23, name: 'Натрій',   color: 'bg-purple-100 text-purple-900 border-purple-300' },
            'Cl': { m: 35.5, name: 'Хлор',   color: 'bg-green-100 text-green-900 border-green-300' },
            'Ca': { m: 40, name: 'Кальцій',  color: 'bg-orange-100 text-orange-900 border-orange-300' },
            'S':  { m: 32, name: 'Сульфур',  color: 'bg-yellow-100 text-yellow-900 border-yellow-400' },
            'Si': { m: 28, name: 'Силіцій',  color: 'bg-stone-200 text-stone-800 border-stone-400' },
        };

        const MOLECULES_LIST = [
            { id: 'h2o',     f: 'H₂O',      name: 'Вода',              vp: 3, count: 6, req: { 'H': 2, 'O': 1 } },
            { id: 'co',      f: 'CO',       name: 'Чадний газ',        vp: 4, count: 4, req: { 'C': 1, 'O': 1 } },
            { id: 'hcl',     f: 'HCl',      name: 'Хлоридна кислота',  vp: 6, count: 3, req: { 'H': 1, 'Cl': 1 } },
            { id: 'cao',     f: 'CaO',      name: 'Негашене вапно',    vp: 4, count: 3, req: { 'Ca': 1, 'O': 1 } },
            { id: 'co2',     f: 'CO₂',      name: 'Вуглекислий газ',   vp: 5, count: 5, req: { 'C': 1, 'O': 2 } },
            { id: 'nacl',    f: 'NaCl',     name: 'Кухонна сіль',      vp: 8, count: 4, req: { 'Na': 1, 'Cl': 1 } },
            { id: 'naoh',    f: 'NaOH',     name: 'Каустична сода',    vp: 5, count: 3, req: { 'Na': 1, 'O': 1, 'H': 1 } },
            { id: 'nh3',     f: 'NH₃',      name: 'Аміак',             vp: 8, count: 2, req: { 'N': 1, 'H': 3 } },
            { id: 'h2o2',    f: 'H₂O₂',     name: 'Перекис водню',     vp: 4, count: 2, req: { 'H': 2, 'O': 2 } },
            { id: 'so2',     f: 'SO₂',      name: 'Сірчистий газ',     vp: 4, count: 2, req: { 'S': 1, 'O': 2 } },
            { id: 'sio2',    f: 'SiO₂',     name: 'Пісок',             vp: 10, count: 2, req: { 'Si': 1, 'O': 2 } },
            { id: 'caoh2',   f: 'Ca(OH)₂',  name: 'Гашене вапно',      vp: 7, count: 2, req: { 'Ca': 1, 'O': 2, 'H': 2 } },
            { id: 'h2so4',   f: 'H₂SO₄',    name: 'Сульфатна кислота', vp: 12, count: 1, req: { 'H': 2, 'S': 1, 'O': 4 } },
            { id: 'caco3',   f: 'CaCO₃',    name: 'Крейда',            vp: 9, count: 3, req: { 'Ca': 1, 'C': 1, 'O': 3 } },
            { id: 'nahco3',  f: 'NaHCO₃',   name: 'Харчова сода',      vp: 10, count: 3, req: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 } },
            { id: 'na2co3',  f: 'Na₂CO₃',   name: 'Кальцинована сода', vp: 12, count: 3, req: { 'Na': 2, 'C': 1, 'O': 3 } },
        ];

        // --- ДОПОМІЖНІ ФУНКЦІЇ ---
        const shuffleArray = (arr) => [...arr].sort(() => Math.random() - 0.5);
        const checkRecipe = (hand, req) => {
            const counts = {};
            hand.forEach(el => counts[el] = (counts[el] || 0) + 1);
            return Object.entries(req).every(([el, n]) => (counts[el] || 0) >= n);
        };

        // --- КОМПОНЕНТИ КАРТ ---
        const ElementCard = ({ type, mini, onClick, selected, style, overlap }) => {
            const data = ELEMENTS[type] || { m: '?', name: type, color: 'bg-gray-300' };
            if (mini) return (
                <div onClick={onClick} className={`w-10 h-12 rounded border flex items-center justify-center font-bold text-sm cursor-pointer shadow-sm ${data.color} ${selected ? 'ring-2 ring-blue-600 scale-110 z-10' : ''}`}>
                    {type}
                </div>
            );
            return (
                <div onClick={onClick} style={style} className={`relative w-20 h-32 sm:w-24 sm:h-36 rounded-xl border-2 flex flex-col justify-between p-2 cursor-pointer transition-all duration-300 flex-shrink-0 ${data.color} ${selected ? 'ring-4 ring-blue-500 -translate-y-8 z-30' : 'hover:-translate-y-4 hover:z-20'} ${overlap ? '-ml-12 hover:ml-1' : ''}`}>
                    <div className="flex justify-between font-bold text-xs sm:text-sm"><span>{type}</span><span className="opacity-60">{data.m}</span></div>
                    <div className="text-center"><div className="text-3xl sm:text-4xl font-black font-serif">{type}</div><div className="text-[0.6rem] uppercase opacity-70 truncate">{data.name}</div></div>
                    <div className="flex justify-between font-bold text-xs sm:text-sm rotate-180"><span>{type}</span><span className="opacity-60">{data.m}</span></div>
                </div>
            );
        };

        const MoleculeCard = ({ mol, canBuy, onBuy }) => (
            <div onClick={() => canBuy && onBuy(mol)} className={`relative w-[45%] sm:w-36 h-auto min-h-[160px] bg-[#fffdf5] rounded-xl border-2 border-[#006400] shadow-lg flex flex-col p-2 transition-all ${canBuy ? 'ring-4 ring-green-400 cursor-pointer scale-105' : ''}`}>
                <div className="absolute top-0 right-0 bg-[#006400] text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">{mol.vp} VP</div>
                <div className="text-center mt-2 border-b border-green-800/10 pb-1">
                    <div className="text-xl sm:text-2xl font-bold font-serif">{mol.f}</div>
                    <div className="text-[10px] uppercase text-gray-600 font-bold">{mol.name}</div>
                </div>
                <div className="flex flex-wrap justify-center gap-1 mt-auto pb-1">
                    {Object.entries(mol.req).map(([el, n]) => Array(n).fill(0).map((_, i) => (
                        <div key={el+i} className={`w-5 h-5 rounded-full border border-black/10 flex items-center justify-center text-[10px] font-bold ${ELEMENTS[el].color}`}>{el}</div>
                    )))}
                </div>
            </div>
        );

        // --- ГОЛОВНА ЛОГІКА ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [gameId, setGameId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [playerName, setPlayerName] = useState('');
            const [targetId, setTargetId] = useState('');
            const [selected, setSelected] = useState([]);
            const [notification, setNotification] = useState(null);
            const [tradeMode, setTradeMode] = useState(false);
            const [tradeStep, setTradeStep] = useState(0);
            const [tradeOffer, setTradeOffer] = useState({ wantEl: null, giveIdxs: [] });

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!gameId || !user) return;
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), (s) => {
                    if (s.exists()) setGameData(s.data());
                    else setNotification({ type: 'error', msg: 'Гру не знайдено' });
                });
                return unsub;
            }, [gameId, user]);

            const myIndex = gameData?.players.findIndex(p => p.uid === user?.uid) ?? -1;
            const myPlayer = myIndex !== -1 ? gameData.players[myIndex] : null;
            const isMyTurn = gameData?.status === 'playing' && gameData?.turnIndex === myIndex;
            
            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const copyRoomCode = () => {
                const el = document.createElement('textarea');
                el.value = gameId;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                notify('Код кімнати скопійовано!');
            };

            const createGame = async () => {
                if (!playerName.trim()) return notify('Введіть ім\'я!', 'error');
                const id = Math.random().toString(36).substring(2, 8).toUpperCase();
                const deck = [];
                Object.entries({'H':24,'O':34,'C':12,'Na':10,'Cl':7,'Ca':8,'N':7,'S':6,'Si':4}).forEach(([el,n])=> {for(let i=0;i<n;i++) deck.push(el)});
                const molDeck = shuffleArray(MOLECULES_LIST.flatMap(m => Array(m.count).fill(0).map((_,i)=>({...m, uniqueId: `${m.id}_${i}_${Math.random()}`} ))));
                
                const data = {
                    id, status: 'waiting', turnIndex: 0, turnPhase: 'draw',
                    players: [{ uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] }],
                    elementDeck: shuffleArray(deck), market: molDeck.splice(0, 4), moleculeDeck: molDeck,
                    logs: [{ text: `Гру створено: ${playerName}`, time: Date.now() }]
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', id), data)
                    .then(() => setGameId(id))
                    .catch(() => notify('Помилка доступу Firestore!', 'error'));
            };

            const joinGame = async () => {
                if (!playerName.trim()) return notify('Введіть ім\'я!', 'error');
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', targetId.toUpperCase());
                await runTransaction(db, async (t) => {
                    const s = await t.get(ref);
                    if (!s.exists()) throw "Кімнати немає";
                    const d = s.data();
                    if (d.players.length >= 4) throw "Кімната повна";
                    if (d.players.some(p => p.uid === user.uid)) return;
                    t.update(ref, { 
                        players: arrayUnion({ uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] }),
                        logs: arrayUnion({ text: `${playerName} приєднався`, time: Date.now() })
                    });
                }).then(() => setGameId(targetId.toUpperCase())).catch(e => notify(e, 'error'));
            };

            const startGame = async () => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const deck = [...gameData.elementDeck];
                const players = gameData.players.map(p => ({ ...p, hand: deck.splice(0, 5) }));
                await updateDoc(ref, { status: 'playing', players, elementDeck: deck, logs: arrayUnion({ text: 'Гру розпочато!', time: Date.now() }) });
            };

            const drawCards = async () => {
                if (!isMyTurn || gameData.turnPhase !== 'draw') return;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const deck = [...gameData.elementDeck];
                const players = [...gameData.players];
                players[myIndex].hand.push(...deck.splice(0, 2));
                await updateDoc(ref, { 
                    players, elementDeck: deck, turnPhase: 'action', 
                    logs: arrayUnion({ text: `${myPlayer.name} взяв ресурси`, time: Date.now() }) 
                });
            };

            const synthesize = async (mol) => {
                if (!isMyTurn || gameData.turnPhase !== 'action') return;
                if (!checkRecipe(myPlayer.hand, mol.req)) return notify('Недостатньо атомів!', 'error');
                
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const players = [...gameData.players];
                const p = players[myIndex];
                Object.entries(mol.req).forEach(([el, n]) => { for(let i=0; i<n; i++) p.hand.splice(p.hand.indexOf(el), 1); });
                p.score += mol.vp;
                p.molecules.push(mol.id);
                
                const market = gameData.market.filter(m => m.uniqueId !== mol.uniqueId);
                const molDeck = [...gameData.moleculeDeck];
                if (molDeck.length) market.push(molDeck.shift());

                await updateDoc(ref, { players, market, moleculeDeck: molDeck, logs: arrayUnion({ text: `${p.name} синтезував ${mol.name} (+${mol.vp})`, time: Date.now() }) });
                if (p.score >= 50) await updateDoc(ref, { status: 'finished' });
            };

            const endTurn = async () => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                await updateDoc(ref, { turnIndex: (gameData.turnIndex + 1) % gameData.players.length, turnPhase: 'draw', logs: arrayUnion({ text: `Хід перейшов до наступного гравця`, time: Date.now() }) });
            };

            const handleTradeRequest = async (targetUid) => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const giveCards = tradeOffer.giveIdxs.map(i => myPlayer.hand[i]);
                await updateDoc(ref, { 
                    activeTrade: { fromUid: user.uid, fromName: myPlayer.name, targetUid, giveCards, wantEl: tradeOffer.wantEl, status: 'pending' },
                    logs: arrayUnion({ text: `${myPlayer.name} запропонував обмін`, time: Date.now() })
                });
                setTradeMode(false); setTradeStep(0); setSelected([]);
            };

            const respondTrade = async (accept) => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const trade = gameData.activeTrade;
                if (!accept) {
                    // ТУТ ВИПРАВЛЕНО: Використовуємо trade.fromName замість ID
                    await updateDoc(ref, { activeTrade: null, logs: arrayUnion({ text: `${myPlayer.name} відхилив обмін від ${trade.fromName}`, time: Date.now() }) });
                    return;
                }
                // Логіка успішного обміну (спрощено)
                await runTransaction(db, async (t) => {
                    const s = await t.get(ref);
                    const d = s.data();
                    const sender = d.players.find(p => p.uid === trade.fromUid);
                    const receiver = d.players.find(p => p.uid === user.uid);
                    
                    trade.giveCards.forEach(c => sender.hand.splice(sender.hand.indexOf(c), 1));
                    receiver.hand.push(...trade.giveCards);
                    
                    receiver.hand.splice(receiver.hand.indexOf(trade.wantEl), 1);
                    sender.hand.push(trade.wantEl);
                    
                    t.update(ref, { players: d.players, activeTrade: null, logs: arrayUnion({ text: `Обмін успішно завершено!`, time: Date.now() }) });
                });
            };

            // --- UI ---
            if (!gameId) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-900">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full animate-fade-in">
                        <h1 className="text-4xl font-black text-green-800 text-center mb-6 tracking-tighter">СИНТЕЗ</h1>
                        <input value={playerName} onChange={e=>setPlayerName(e.target.value)} placeholder="Ваше ім'я" className="w-full border-2 p-3 rounded-xl mb-4 focus:border-green-500 outline-none font-bold" />
                        <button onClick={createGame} className="w-full bg-green-700 text-white p-4 rounded-xl font-bold mb-4 shadow-lg flex items-center justify-center gap-2 hover:bg-green-800"><Atom/> Створити гру</button>
                        <div className="flex gap-2">
                            <input value={targetId} onChange={e=>setTargetId(e.target.value)} placeholder="Код" className="flex-grow border-2 p-3 rounded-xl uppercase font-mono" />
                            <button onClick={joinGame} className="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Увійти</button>
                        </div>
                    </div>
                </div>
            );

            if (gameData?.status === 'waiting') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-100 p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-lg border-t-8 border-green-700">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-green-800">Кімната: <span className="font-mono">{gameId}</span></h2>
                            <button onClick={copyRoomCode} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><ClipboardCopy size={20}/></button>
                        </div>
                        <div className="space-y-3 mb-8">
                            {gameData.players.map((p, i) => (
                                <div key={i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-200">
                                    <div className="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">{p.name[0]}</div>
                                    <span className="font-bold flex-grow">{p.name}</span>
                                    {i === 0 && <Crown className="text-yellow-500" size={20}/>}
                                </div>
                            ))}
                        </div>
                        {myIndex === 0 ? <button onClick={startGame} className="w-full bg-green-700 text-white py-4 rounded-2xl font-bold text-xl shadow-lg">Розпочати гру</button> : <div className="text-center text-gray-400 animate-pulse">Очікування хоста...</div>}
                    </div>
                </div>
            );

            return (
                <div className="h-screen flex flex-col md:flex-row overflow-hidden">
                    {/* Sidebar - ТУТ ДОДАНО ПОКРАЩЕННЯ ДЛЯ НОУТБУКІВ */}
                    <aside className="w-full md:w-64 bg-white border-r flex flex-col z-20 shadow-lg shrink-0">
                        <div className="p-4 bg-slate-800 text-white flex justify-between items-center">
                            <span className="font-black tracking-tighter text-xl">СИНТЕЗ</span>
                            <div className="text-[10px] bg-white/20 px-2 py-1 rounded flex items-center gap-1 cursor-pointer" onClick={copyRoomCode}>
                                {gameId} <ClipboardCopy size={10}/>
                            </div>
                        </div>
                        <div className="p-4 space-y-2 overflow-y-auto">
                            {gameData?.players.map((p, i) => (
                                <div key={p.uid} className={`p-3 rounded-xl border-2 transition-all ${gameData.turnIndex === i ? 'border-green-500 bg-green-50 shadow-md scale-105' : 'border-transparent bg-slate-50'}`}>
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold text-sm truncate max-w-[100px]">{p.name}</span>
                                        <span className="bg-yellow-400 text-black px-2 py-0.5 rounded-lg text-xs font-black">{p.score} VP</span>
                                    </div>
                                    {/* Детальна інфа для ПК */}
                                    <div className="flex justify-between mt-2">
                                        <div className="flex items-center gap-1 text-[10px] text-gray-500 font-bold uppercase">
                                            <Layers size={10}/> Карт: <span className="text-blue-600 text-xs">{p.hand.length}</span>
                                        </div>
                                        <div className="flex items-center gap-1 text-[10px] text-gray-500 font-bold uppercase">
                                            <FlaskConical size={10}/> Мол: <span className="text-green-700 text-xs">{p.molecules.length}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-auto p-4 border-t h-40 overflow-hidden flex flex-col">
                            <h4 className="text-[10px] font-black text-gray-400 uppercase mb-2">Журнал</h4>
                            <div className="flex-grow overflow-y-auto custom-scrollbar text-[10px] font-mono space-y-1">
                                {gameData?.logs.slice(-20).reverse().map((l, i) => <div key={i} className="border-l-2 border-slate-300 pl-2">{l.text}</div>)}
                            </div>
                        </div>
                    </aside>

                    {/* Main Arena */}
                    <main className="flex-grow flex flex-col relative overflow-hidden">
                        <section className="flex-grow p-4 bg-slate-200 overflow-y-auto pb-40">
                            <div className="max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
                                {gameData?.market.map(m => (
                                    <MoleculeCard key={m.uniqueId} mol={m} canBuy={isMyTurn && gameData.turnPhase === 'action'} onBuy={synthesize} />
                                ))}
                            </div>
                        </section>

                        {/* Trade Overlay */}
                        {gameData?.activeTrade?.targetUid === user?.uid && (
                            <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center animate-fade-in">
                                    <h3 className="text-xl font-bold mb-4">Пропозиція від {gameData.activeTrade.fromName}</h3>
                                    <div className="flex items-center justify-around bg-slate-50 p-4 rounded-xl mb-6">
                                        <div className="text-blue-600 font-bold">{gameData.activeTrade.giveCards.join(', ')}</div>
                                        <ArrowRightLeft className="text-gray-300"/>
                                        <div className="text-red-600 font-bold">1x {gameData.activeTrade.wantEl}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => respondTrade(false)} className="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold">Відмовити</button>
                                        <button onClick={() => respondTrade(true)} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">Прийняти</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Hand & Controls */}
                        <footer className="bg-white border-t p-4 z-40 shadow-2xl">
                            <div className="max-w-5xl mx-auto">
                                <div className="flex overflow-x-auto scrollbar-hide h-40 sm:h-52 items-end mb-4 px-10">
                                    {myPlayer?.hand.map((c, i) => (
                                        <ElementCard key={i} type={c} overlap={true} selected={selected.includes(i)} onClick={() => {
                                            if (selected.includes(i)) setSelected(selected.filter(x => x !== i));
                                            else setSelected([...selected, i]);
                                        }} />
                                    ))}
                                </div>
                                
                                <div className="flex justify-center gap-3">
                                    {isMyTurn && gameData.turnPhase === 'draw' && (
                                        <button onClick={drawCards} className="bg-blue-600 text-white px-10 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 animate-bounce">Взяти 2 ресурси</button>
                                    )}
                                    {isMyTurn && gameData.turnPhase === 'action' && (
                                        <>
                                            <button onClick={() => { setTradeMode(true); setTradeStep(1); setTradeOffer({ ...tradeOffer, giveIdxs: selected }); }} className="bg-indigo-100 text-indigo-700 px-6 py-3 rounded-full font-bold border border-indigo-200">Обмін</button>
                                            <button onClick={endTurn} className="bg-green-600 text-white px-10 py-3 rounded-full font-bold shadow-lg">Завершити хід</button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </footer>
                    </main>

                    {/* Trade Step Modal */}
                    {tradeMode && tradeStep === 1 && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
                                <h3 className="font-bold mb-4">Який атом ви хочете?</h3>
                                <div className="grid grid-cols-5 gap-2">
                                    {Object.keys(ELEMENTS).map(el => (
                                        <div key={el} onClick={() => { setTradeOffer({ ...tradeOffer, wantEl: el }); setTradeStep(2); }} className={`p-2 border rounded cursor-pointer text-center font-bold ${ELEMENTS[el].color}`}>{el}</div>
                                    ))}
                                </div>
                                <button onClick={() => setTradeMode(false)} className="w-full mt-4 text-gray-400">Скасувати</button>
                            </div>
                        </div>
                    )}
                    {tradeMode && tradeStep === 2 && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
                                <h3 className="font-bold mb-4">Кому запропонувати?</h3>
                                <div className="space-y-2">
                                    {gameData.players.map((p, i) => i !== myIndex && (
                                        <button key={p.uid} onClick={() => handleTradeRequest(p.uid)} className="w-full p-3 bg-slate-50 rounded-xl font-bold hover:bg-slate-100">{p.name}</button>
                                    ))}
                                </div>
                                <button onClick={() => setTradeMode(false)} className="w-full mt-4 text-gray-400">Скасувати</button>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white font-bold shadow-2xl z-[100] animate-fade-in ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>
                            {notification.msg}
                        </div>
                    )}
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
