<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СИНТЕЗ - Елітна Хімічна Стратегія (GitHub Version)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Montserrat:wght@400;600;800&display=swap');

        :root {
            --premium-green: #006400;
            --gold-gradient: radial-gradient(circle at center, #fffdf5 0%, #fceeb5 100%);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #121212;
            color: #333;
        }

        .card-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23006400' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .molecule-card {
            background: var(--gold-gradient);
            border: 2px solid var(--premium-green);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .molecule-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .atom-badge {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(252, 238, 181, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(252, 238, 181, 0); }
            100% { box-shadow: 0 0 0 0 rgba(252, 238, 181, 0); }
        }
        .active-turn-ring {
            animation: pulse-gold 2s infinite;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, arrayUnion, runTransaction } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            Atom, FlaskConical, Users, Copy, Check, AlertTriangle, 
            ArrowRightLeft, Play, Crown, LogOut, Loader2, X, RefreshCcw, LayoutGrid, Trash2, ClipboardCopy, Layers, History, Shield
        } from 'https://esm.sh/lucide-react@0.263.1';

        // ==========================================
        // ВАШІ НАЛАШТУВАННЯ FIREBASE (GITHUB READY)
        // ==========================================
        const firebaseConfig = {
        apiKey: "AIzaSyCCMdryzKt4-sRq2snh16Ciug2V_cRcBIU",
        authDomain: "synthesis-game-chem.firebaseapp.com",
        projectId: "synthesis-game-chem",
        storageBucket: "synthesis-game-chem.firebasestorage.app",
        messagingSenderId: "441318316675",
        appId: "1:441318316675:web:361daca49c3924e94a99b6"
        };

        const appIdCol = "synthesis-game-v1"; // Назва колекції в Firestore

        // Ініціалізація з перевіркою
        let app, auth, db;
        const isConfigured = firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("ВАШ_");

        if (isConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }
        }

        // --- ДАНІ ГРИ ---
        const ELEMENTS = {
            'H':  { m: 1,  name: 'Гідроген', color: 'bg-blue-100 text-blue-900 border-blue-300' },
            'O':  { m: 16, name: 'Оксиген',  color: 'bg-red-100 text-red-900 border-red-300' },
            'C':  { m: 12, name: 'Карбон',   color: 'bg-stone-300 text-stone-900 border-stone-400' },
            'N':  { m: 14, name: 'Нітроген', color: 'bg-indigo-100 text-indigo-900 border-indigo-300' },
            'Na': { m: 23, name: 'Натрій',   color: 'bg-purple-100 text-purple-900 border-purple-300' },
            'Cl': { m: 35.5, name: 'Хлор',   color: 'bg-green-100 text-green-900 border-green-300' },
            'Ca': { m: 40, name: 'Кальцій',  color: 'bg-orange-100 text-orange-900 border-orange-300' },
            'S':  { m: 32, name: 'Сульфур',  color: 'bg-yellow-100 text-yellow-900 border-yellow-400' },
            'Si': { m: 28, name: 'Силіцій',  color: 'bg-amber-200 text-amber-900 border-amber-300' },
        };

        const MOLECULES_LIST = [
            { id: 'h2o',     f: 'H₂O',      name: 'Вода',              vp: 3, count: 6, req: { 'H': 2, 'O': 1 } },
            { id: 'co',      f: 'CO',       name: 'Чадний газ',        vp: 4, count: 4, req: { 'C': 1, 'O': 1 } },
            { id: 'hcl',     f: 'HCl',      name: 'Хлоридна кислота',  vp: 6, count: 3, req: { 'H': 1, 'Cl': 1 } },
            { id: 'cao',     f: 'CaO',      name: 'Негашене вапно',    vp: 4, count: 3, req: { 'Ca': 1, 'O': 1 } },
            { id: 'co2',     f: 'CO₂',      name: 'Вуглекислий газ',   vp: 5, count: 5, req: { 'C': 1, 'O': 2 } },
            { id: 'nacl',    f: 'NaCl',     name: 'Кухонна сіль',      vp: 8, count: 4, req: { 'Na': 1, 'Cl': 1 } },
            { id: 'naoh',    f: 'NaOH',     name: 'Каустична сода',    vp: 5, count: 3, req: { 'Na': 1, 'O': 1, 'H': 1 } },
            { id: 'nh3',     f: 'NH₃',      name: 'Аміак',             vp: 8, count: 2, req: { 'N': 1, 'H': 3 } },
            { id: 'h2o2',    f: 'H₂O₂',     name: 'Перекис водню',     vp: 4, count: 2, req: { 'H': 2, 'O': 2 } },
            { id: 'so2',     f: 'SO₂',      name: 'Сірчистий газ',     vp: 4, count: 2, req: { 'S': 1, 'O': 2 } },
            { id: 'sio2',    f: 'SiO₂',     name: 'Пісок',             vp: 10, count: 2, req: { 'Si': 1, 'O': 2 } },
            { id: 'caoh2',   f: 'Ca(OH)₂',  name: 'Гашене вапно',      vp: 7, count: 2, req: { 'Ca': 1, 'O': 2, 'H': 2 } },
            { id: 'h2so4',   f: 'H₂SO₄',    name: 'Сульфатна кислота', vp: 12, count: 1, req: { 'H': 2, 'S': 1, 'O': 4 } },
            { id: 'caco3',   f: 'CaCO₃',    name: 'Крейда',            vp: 9, count: 3, req: { 'Ca': 1, 'C': 1, 'O': 3 } },
            { id: 'nahco3',  f: 'NaHCO₃',   name: 'Харчова сода',      vp: 10, count: 3, req: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 } },
            { id: 'na2co3',  f: 'Na₂CO₃',   name: 'Кальцинована сода', vp: 12, count: 3, req: { 'Na': 2, 'C': 1, 'O': 3 } },
        ];

        const shuffleArray = (arr) => [...arr].sort(() => Math.random() - 0.5);
        const checkRecipe = (hand, req) => {
            const counts = {};
            hand.forEach(el => counts[el] = (counts[el] || 0) + 1);
            return Object.entries(req).every(([el, n]) => (counts[el] || 0) >= n);
        };

        const ElementCard = ({ type, mini, onClick, selected, style, overlap }) => {
            const data = ELEMENTS[type] || { m: '?', name: type, color: 'bg-gray-300' };
            if (mini) return (
                <div onClick={onClick} className={`w-10 h-12 rounded-lg border-2 flex items-center justify-center font-bold text-sm cursor-pointer shadow-sm transition-all ${data.color} ${selected ? 'ring-4 ring-blue-400 -translate-y-1' : ''}`}>
                    {type}
                </div>
            );
            return (
                <div onClick={onClick} style={style} className={`relative w-24 h-36 sm:w-28 sm:h-40 rounded-xl border-2 flex flex-col justify-between p-3 cursor-pointer shadow-lg transition-all duration-300 ${data.color} ${selected ? 'ring-4 ring-blue-500 -translate-y-10 z-40' : 'hover:-translate-y-4 hover:z-20'} ${overlap ? '-ml-16 sm:-ml-20 hover:ml-2' : ''}`}>
                    <div className="flex justify-between font-extrabold text-sm"><span>{type}</span><span className="opacity-40">{data.m}</span></div>
                    <div className="text-center">
                        <div className="text-4xl sm:text-5xl font-black font-serif tracking-tighter">{type}</div>
                        <div className="text-[0.6rem] uppercase font-bold tracking-widest opacity-60 truncate mt-1">{data.name}</div>
                    </div>
                    <div className="flex justify-between font-extrabold text-sm rotate-180"><span>{type}</span><span className="opacity-40">{data.m}</span></div>
                </div>
            );
        };

        const MoleculeCard = ({ mol, canBuy, onBuy }) => (
            <div onClick={() => canBuy && onBuy(mol)} className={`molecule-card relative w-[46%] sm:w-40 h-52 sm:h-60 rounded-2xl flex flex-col p-3 ${canBuy ? 'ring-4 ring-green-400' : ''}`}>
                <div className="absolute top-2 right-2 bg-[#006400] text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-md z-10">{mol.vp} VP</div>
                <div className="card-pattern absolute inset-0 opacity-20 pointer-events-none rounded-2xl"></div>
                <div className="text-center mt-4 border-b-2 border-green-900/10 pb-2 z-10">
                    <div className="text-2xl sm:text-3xl font-black font-serif text-gray-800">{mol.f}</div>
                    <div className="text-[9px] uppercase text-green-900/60 font-extrabold leading-tight mt-1">{mol.name}</div>
                </div>
                <div className="flex flex-wrap justify-center gap-1.5 mt-auto pb-2 z-10">
                    {Object.entries(mol.req).map(([el, n]) => Array(n).fill(0).map((_, i) => (
                        <div key={el+i} className={`atom-badge w-6 h-6 rounded-full border border-black/10 flex items-center justify-center text-[10px] font-black shadow-sm ${ELEMENTS[el].color}`}>{el}</div>
                    )))}
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [gameId, setGameId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [playerName, setPlayerName] = useState('');
            const [targetId, setTargetId] = useState('');
            const [selected, setSelected] = useState([]);
            const [notification, setNotification] = useState(null);
            const [tradeMode, setTradeMode] = useState(false);
            const [tradeStep, setTradeStep] = useState(0);
            const [tradeOffer, setTradeOffer] = useState({ wantEl: null, giveIdxs: [] });

            useEffect(() => {
                if (!isConfigured) {
                    setNotification({ type: 'error', msg: 'Firebase Config не налаштовано! Вставте ключі в код.' });
                    return;
                }

                const setupAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Auth Failure:", e);
                        setNotification({ type: 'error', msg: 'Помилка мережі Firebase! Перевірте ключі та дозволи (Auth -> Anonymous).' });
                    }
                };

                setupAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!gameId || !user || !db) return;
                const unsub = onSnapshot(doc(db, 'games', gameId), (s) => {
                    if (s.exists()) setGameData(s.data());
                    else { setNotification({ type: 'error', msg: 'Гру не знайдено' }); setGameId(''); }
                }, (err) => {
                    console.error("Firestore error:", err);
                    setNotification({ type: 'error', msg: 'Помилка доступу Firestore! Перевірте Rules.' });
                });
                return unsub;
            }, [gameId, user]);

            const myIndex = gameData?.players.findIndex(p => p.uid === user?.uid) ?? -1;
            const myPlayer = myIndex !== -1 ? gameData.players[myIndex] : null;
            const isMyTurn = gameData?.status === 'playing' && gameData?.turnIndex === myIndex;
            
            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 5000);
            };

            const copyCode = () => {
                const el = document.createElement('textarea');
                el.value = gameId; el.style.position = 'absolute'; el.style.left = '-9999px';
                document.body.appendChild(el); el.select();
                document.execCommand('copy'); document.body.removeChild(el);
                notify('Код кімнати скопійовано!');
            };

            const createGame = async () => {
                if (!playerName.trim()) return notify('Введіть ім\'я!', 'error');
                if (!isConfigured) return notify('Firebase не налаштовано!', 'error');

                const id = Math.random().toString(36).substring(2, 8).toUpperCase();
                const deck = [];
                Object.entries({'H':24,'O':34,'C':12,'Na':10,'Cl':7,'Ca':8,'N':7,'S':6,'Si':4}).forEach(([el,n])=> {for(let i=0;i<n;i++) deck.push(el)});
                const molDeck = MOLECULES_LIST.flatMap(m => Array(m.count).fill(0).map((_,i)=>({...m, uniqueId: `${m.id}_${i}_${Math.random()}`} ))).sort(() => Math.random() - 0.5);
                
                const data = {
                    id, status: 'waiting', turnIndex: 0, turnPhase: 'draw',
                    players: [{ uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] }],
                    elementDeck: deck.sort(() => Math.random() - 0.5), market: molDeck.splice(0, 4), moleculeDeck: molDeck,
                    logs: [{ text: `Гру створено: ${playerName}`, time: Date.now() }]
                };
                
                try {
                    await setDoc(doc(db, 'games', id), data);
                    setGameId(id);
                } catch (e) {
                    console.error(e);
                    notify('Помилка запису! Перевірте Firestore Rules.', 'error');
                }
            };

            const joinGame = async () => {
                if (!playerName.trim() || !targetId.trim()) return notify('Введіть дані!', 'error');
                const ref = doc(db, 'games', targetId.toUpperCase());
                await runTransaction(db, async (t) => {
                    const s = await t.get(ref); if (!s.exists()) throw "Кімнати немає";
                    const d = s.data(); if (d.players.length >= 4) throw "Кімната повна";
                    if (d.players.some(p => p.uid === user.uid)) return;
                    t.update(ref, { 
                        players: arrayUnion({ uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] }),
                        logs: arrayUnion({ text: `${playerName} приєднався до гри`, time: Date.now() })
                    });
                }).then(() => setGameId(targetId.toUpperCase())).catch(e => notify(e, 'error'));
            };

            const startGame = async () => {
                const ref = doc(db, 'games', gameId);
                const deck = [...gameData.elementDeck];
                const players = gameData.players.map(p => ({ ...p, hand: deck.splice(0, 5) }));
                await updateDoc(ref, { status: 'playing', players, elementDeck: deck, logs: arrayUnion({ text: 'Гру розпочато! Всім роздано по 5 атомів.', time: Date.now() }) });
            };

            const drawCards = async () => {
                if (!isMyTurn || gameData.turnPhase !== 'draw') return;
                const ref = doc(db, 'games', gameId);
                const deck = [...gameData.elementDeck];
                const players = [...gameData.players];
                const drawn = deck.splice(0, 2);
                players[myIndex].hand.push(...drawn);
                await updateDoc(ref, { 
                    players, elementDeck: deck, turnPhase: 'action', 
                    logs: arrayUnion({ text: `${myPlayer.name} взяв 2 ресурси`, time: Date.now() }) 
                });
            };

            const synthesize = async (mol) => {
                if (!isMyTurn || gameData.turnPhase !== 'action') return;
                if (!checkRecipe(myPlayer.hand, mol.req)) return notify('Недостатньо атомів!', 'error');
                
                const ref = doc(db, 'games', gameId);
                const players = [...gameData.players];
                const p = players[myIndex];
                Object.entries(mol.req).forEach(([el, n]) => { for(let i=0; i<n; i++) p.hand.splice(p.hand.indexOf(el), 1); });
                p.score += mol.vp;
                p.molecules.push(mol.id);
                
                const market = gameData.market.filter(m => m.uniqueId !== mol.uniqueId);
                const molDeck = [...gameData.moleculeDeck];
                if (molDeck.length) market.push(molDeck.shift());

                await updateDoc(ref, { players, market, moleculeDeck: molDeck, logs: arrayUnion({ text: `${p.name} синтезував ${mol.name} (+${mol.vp} VP)`, time: Date.now() }) });
                if (p.score >= 50) await updateDoc(ref, { status: 'finished' });
            };

            const handleTrade = async (targetUid) => {
                const ref = doc(db, 'games', gameId);
                const giveCards = tradeOffer.giveIdxs.map(i => myPlayer.hand[i]);
                const targetPlayer = gameData.players.find(p => p.uid === targetUid);
                await updateDoc(ref, { 
                    activeTrade: { fromUid: user.uid, fromName: myPlayer.name, targetUid, targetName: targetPlayer.name, giveCards, wantEl: tradeOffer.wantEl, status: 'pending' },
                    logs: arrayUnion({ text: `${myPlayer.name} пропонує обмін ${targetPlayer.name}`, time: Date.now() })
                });
                setTradeMode(false); setTradeStep(0); setSelected([]);
            };

            const respondTrade = async (accept) => {
                const ref = doc(db, 'games', gameId);
                const trade = gameData.activeTrade;
                if (!accept) {
                    await updateDoc(ref, { activeTrade: null, logs: arrayUnion({ text: `${myPlayer.name} відхилив обмін від ${trade.fromName}`, time: Date.now() }) });
                    return;
                }
                await runTransaction(db, async (t) => {
                    const s = await t.get(ref); const d = s.data();
                    const sender = d.players.find(p => p.uid === trade.fromUid);
                    const receiver = d.players.find(p => p.uid === user.uid);
                    trade.giveCards.forEach(c => sender.hand.splice(sender.hand.indexOf(c), 1));
                    receiver.hand.push(...trade.giveCards);
                    receiver.hand.splice(receiver.hand.indexOf(trade.wantEl), 1);
                    sender.hand.push(trade.wantEl);
                    t.update(ref, { players: d.players, activeTrade: null, logs: arrayUnion({ text: `Обмін між ${sender.name} та ${receiver.name} завершено успішно`, time: Date.now() }) });
                }).catch(e => notify('Помилка обміну', 'error'));
            };

            const nextTurn = async () => {
                const ref = doc(db, 'games', gameId);
                const nextIdx = (gameData.turnIndex + 1) % gameData.players.length;
                await updateDoc(ref, { turnIndex: nextIdx, turnPhase: 'draw', logs: arrayUnion({ text: `Хід переходить до ${gameData.players[nextIdx].name}`, time: Date.now() }) });
            };

            if (!isConfigured) return (
                <div className="h-screen flex items-center justify-center bg-black p-6">
                    <div className="bg-red-100 border-4 border-red-500 p-8 rounded-3xl max-w-lg text-center shadow-2xl">
                        <AlertTriangle size={64} className="text-red-600 mx-auto mb-4"/>
                        <h2 className="text-2xl font-black text-red-900 mb-4">FIREBASE CONFIG НЕ ЗНАЙДЕНО!</h2>
                        <p className="text-red-700 font-bold mb-6">Відкрийте код файлу та вставте свої ключі в об'єкт <code className="bg-red-200 px-2 rounded">firebaseConfig</code>.</p>
                        <div className="text-xs text-red-500 font-mono text-left bg-white p-4 rounded-xl border border-red-200">
                            1. Зайдіть у Firebase Console<br/>
                            2. Project Settings -> General -> Your Apps<br/>
                            3. Скопіюйте apiKey, projectId тощо.
                        </div>
                    </div>
                </div>
            );

            if (!user) return <div className="h-screen flex items-center justify-center bg-black text-white font-black text-2xl animate-pulse">З'ЄДНАННЯ З FIREBASE...</div>;

            if (!gameId) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-black to-slate-900 overflow-hidden">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-md w-full border-t-[12px] border-green-800 animate-in zoom-in duration-500">
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-black text-green-900 tracking-tighter mb-2">СИНТЕЗ</h1>
                            <p className="text-xs uppercase tracking-widest text-gray-400 font-bold">The Chemistry Strategy Game</p>
                        </div>
                        <div className="space-y-4">
                            <input value={playerName} onChange={e=>setPlayerName(e.target.value)} placeholder="Ваше ім'я" className="w-full border-2 border-slate-100 p-4 rounded-2xl focus:border-green-600 outline-none font-bold text-center text-lg bg-slate-50 transition-all" />
                            <button onClick={createGame} className="w-full bg-green-800 text-white p-5 rounded-2xl font-black text-xl shadow-xl hover:bg-green-700 hover:scale-[1.02] transition-all flex items-center justify-center gap-3"><Atom size={28}/> СТВОРИТИ ГРУ</button>
                            <div className="relative py-4"><div className="absolute inset-0 flex items-center"><div className="w-full border-t-2 border-slate-100"></div></div><div className="relative flex justify-center text-xs uppercase font-black text-slate-300 bg-white px-4 tracking-widest">АБО</div></div>
                            <div className="flex gap-2">
                                <input value={targetId} onChange={e=>setTargetId(e.target.value)} placeholder="КОД" className="w-2/3 border-2 border-slate-100 p-4 rounded-2xl uppercase font-black tracking-widest text-center focus:border-blue-600 outline-none bg-slate-50" />
                                <button onClick={joinGame} className="w-1/3 bg-blue-600 text-white rounded-2xl font-black hover:bg-blue-700 shadow-xl">УВІЙТИ</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (gameData?.status === 'waiting') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 p-6">
                    <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-xl border-t-[15px] border-green-800 animate-fade-in relative overflow-hidden">
                        <div className="flex justify-between items-center mb-10">
                            <div>
                                <h2 className="text-3xl font-black text-green-900 tracking-tighter">ЗАЛ ОЧІКУВАННЯ</h2>
                                <p className="text-sm font-bold text-gray-400">Кімната: <span className="text-green-600 font-mono text-xl">{gameId}</span></p>
                            </div>
                            <button onClick={copyCode} className="p-4 bg-slate-100 rounded-2xl hover:bg-green-100 text-green-800 transition-all flex items-center gap-2 font-bold shadow-sm">
                                <ClipboardCopy size={24}/> КОПІЮВАТИ
                            </button>
                        </div>
                        <div className="space-y-4 mb-10">
                            {gameData.players.map((p, i) => (
                                <div key={i} className="flex items-center gap-4 p-5 bg-slate-50 rounded-2xl border-2 border-slate-100 shadow-sm animate-in slide-in-from-left duration-300" style={{animationDelay: `${i*100}ms`}}>
                                    <div className="w-12 h-12 rounded-full bg-green-600 text-white flex items-center justify-center font-black text-xl shadow-md">{p.name[0]}</div>
                                    <span className="font-bold text-xl flex-grow">{p.name} {p.uid === user.uid && <span className="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-2">ВИ</span>}</span>
                                    {i === 0 && <div className="flex items-center gap-1 bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-black text-xs border border-yellow-200"><Crown size={14}/> ОРГАНІЗАТОР</div>}
                                </div>
                            ))}
                        </div>
                        {myIndex === 0 ? (
                            <button onClick={startGame} className="w-full bg-green-800 text-white py-5 rounded-3xl font-black text-2xl shadow-2xl hover:bg-green-700 transition-all transform active:scale-95">РОЗПОЧАТИ ГРУ</button>
                        ) : <div className="text-center py-4 text-green-700 font-black animate-pulse flex items-center justify-center gap-2"><Loader2 className="animate-spin"/> ОЧІКУВАННЯ ХОСТА...</div>}
                    </div>
                </div>
            );

            return (
                <div className="h-screen flex flex-col md:flex-row overflow-hidden bg-[#e8e8e8]">
                    {/* PC SIDEBAR */}
                    <aside className="w-full md:w-72 bg-white border-r flex flex-col z-30 shadow-2xl shrink-0">
                        <div className="p-6 bg-green-900 text-white shadow-xl flex justify-between items-center">
                            <div><h3 className="font-black tracking-tighter text-2xl">СИНТЕЗ</h3></div>
                            <button onClick={copyCode} className="p-2 bg-white/10 rounded-lg hover:bg-white/20"><ClipboardCopy size={16}/></button>
                        </div>
                        
                        <div className="p-4 space-y-3 overflow-y-auto flex-grow bg-slate-50/50 custom-scrollbar">
                            {gameData?.players.map((p, i) => (
                                <div key={p.uid} className={`p-4 rounded-2xl border-2 transition-all duration-500 ${gameData.turnIndex === i ? 'border-green-600 bg-white shadow-xl scale-[1.03] active-turn-ring' : 'border-slate-100 bg-slate-50 opacity-80'}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-black text-xs text-white ${gameData.turnIndex === i ? 'bg-green-600' : 'bg-slate-400'}`}>{p.name[0]}</div>
                                            <span className="font-extrabold text-sm truncate max-w-[100px]">{p.name}</span>
                                        </div>
                                        <div className="bg-yellow-400 text-black px-2 py-1 rounded-lg text-xs font-black shadow-sm">{p.score} VP</div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="bg-blue-50 p-2 rounded-xl flex flex-col items-center border border-blue-100">
                                            <span className="text-[9px] font-black text-blue-400 uppercase">Карти</span>
                                            <div className="flex items-center gap-1 font-black text-blue-800"><Layers size={10}/> {p.hand?.length || 0}</div>
                                        </div>
                                        <div className="bg-green-50 p-2 rounded-xl flex flex-col items-center border border-green-100">
                                            <span className="text-[9px] font-black text-green-400 uppercase">Молекули</span>
                                            <div className="flex items-center gap-1 font-black text-green-800"><FlaskConical size={10}/> {p.molecules?.length || 0}</div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-auto p-4 border-t-2 bg-white h-48 flex flex-col">
                            <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2"><History size={12}/> Хроніка</h4>
                            <div className="flex-grow overflow-y-auto custom-scrollbar text-[11px] font-medium space-y-2 text-slate-600">
                                {gameData?.logs.slice(-25).reverse().map((l, i) => (
                                    <div key={i} className="border-l-4 border-slate-200 pl-3 py-0.5">
                                        <span className="text-[9px] text-slate-300 block font-bold">{new Date(l.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                        {l.text}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </aside>

                    {/* ARENA */}
                    <main className="flex-grow flex flex-col relative overflow-hidden">
                        <section className="flex-grow p-4 bg-[#f0f0f0] overflow-y-auto pb-48 scroll-smooth">
                            <div className="max-w-5xl mx-auto">
                                <div className="flex items-center gap-3 mb-8 opacity-40 uppercase tracking-[0.3em] font-black text-xs">
                                    <LayoutGrid size={16}/> Доступні Молекули ({gameData?.market.length})
                                </div>
                                <div className="flex flex-wrap justify-center gap-4 sm:gap-8">
                                    {gameData?.market.map(m => (
                                        <MoleculeCard key={m.uniqueId} mol={m} canBuy={isMyTurn && gameData.turnPhase === 'action'} onBuy={synthesize} />
                                    ))}
                                </div>
                            </div>
                        </section>

                        {/* Trade Receiver Overlay */}
                        {gameData?.activeTrade?.targetUid === user?.uid && (
                            <div className="absolute inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 backdrop-blur-md">
                                <div className="bg-white p-8 rounded-[3rem] shadow-2xl max-w-sm w-full text-center animate-in zoom-in duration-300 border-t-[10px] border-blue-600">
                                    <h3 className="text-2xl font-black mb-2">Пропозиція обміну!</h3>
                                    <p className="text-gray-400 font-bold text-sm mb-6">Від {gameData.activeTrade.fromName}</p>
                                    <div className="flex items-center justify-around bg-slate-50 p-6 rounded-3xl mb-8">
                                        <div className="text-blue-800 font-black text-2xl">{gameData.activeTrade.giveCards.join(', ')}</div>
                                        <ArrowRightLeft className="text-slate-300 animate-pulse" size={32}/>
                                        <div className="text-red-800 font-black text-2xl">1x {gameData.activeTrade.wantEl}</div>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => respondTrade(false)} className="flex-1 bg-red-100 text-red-600 py-4 rounded-2xl font-black">ВІДМОВИТИ</button>
                                        <button onClick={() => respondTrade(true)} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black">ПРИЙНЯТИ</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <footer className="bg-white border-t p-2 sm:p-4 z-40 shadow-[0_-15px_30px_rgba(0,0,0,0.1)] shrink-0">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex overflow-x-auto scrollbar-hide h-44 sm:h-56 items-end mb-4 px-12 sm:px-20 pt-4">
                                    <div className="flex items-end mx-auto">
                                        {myPlayer?.hand.map((c, i) => (
                                            <ElementCard key={i} type={c} overlap={true} selected={selected.includes(i)} onClick={() => {
                                                if (selected.includes(i)) setSelected(selected.filter(x => x !== i));
                                                else setSelected([...selected, i]);
                                            }} />
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex justify-center gap-4 pb-2">
                                    {isMyTurn && gameData.turnPhase === 'draw' && (
                                        <button onClick={drawCards} className="bg-blue-600 text-white px-12 py-4 rounded-full font-black text-lg shadow-2xl hover:scale-105 transition-all flex items-center gap-3"><Layers/> ВЗЯТИ 2 РЕСУРСИ</button>
                                    )}
                                    {isMyTurn && gameData.turnPhase === 'action' && (
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={() => { if(selected.length > 0) { setTradeMode(true); setTradeStep(1); setTradeOffer({ ...tradeOffer, giveIdxs: selected }); } else { notify('Оберіть карту на руці!', 'error'); }}} 
                                                className="bg-indigo-100 text-indigo-700 px-8 py-4 rounded-full font-black border-2 border-indigo-200"
                                            >
                                                ОБМІН
                                            </button>
                                            <button onClick={nextTurn} className="bg-green-700 text-white px-12 py-4 rounded-full font-black text-lg shadow-2xl">ЗАВЕРШИТИ ХІД</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </footer>
                    </main>

                    {/* Trade Modals */}
                    {tradeMode && tradeStep === 1 && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-[3rem] shadow-2xl w-full max-w-sm border-t-[10px] border-indigo-600 animate-in zoom-in duration-200">
                                <h3 className="font-black text-xl mb-6 text-center">Що хочете отримати?</h3>
                                <div className="grid grid-cols-5 gap-3">
                                    {Object.keys(ELEMENTS).map(el => (
                                        <div key={el} onClick={() => { setTradeOffer({ ...tradeOffer, wantEl: el }); setTradeStep(2); }} className={`p-3 border-2 rounded-2xl cursor-pointer text-center font-black transition-all hover:scale-110 ${ELEMENTS[el].color}`}>{el}</div>
                                    ))}
                                </div>
                                <button onClick={() => setTradeMode(false)} className="w-full mt-8 text-slate-400 font-bold">СКАСУВАТИ</button>
                            </div>
                        </div>
                    )}

                    {tradeMode && tradeStep === 2 && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-[3rem] shadow-2xl w-full max-w-sm border-t-[10px] border-indigo-600 animate-in zoom-in duration-200">
                                <h3 className="font-black text-xl mb-6 text-center">Кому запропонувати?</h3>
                                <div className="space-y-3">
                                    {gameData.players.map((p, i) => i !== myIndex && (
                                        <button key={p.uid} onClick={() => handleTrade(p.uid)} className="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl font-extrabold text-lg hover:bg-indigo-50 transition-all">{p.name}</button>
                                    ))}
                                </div>
                                <button onClick={() => setTradeMode(false)} className="w-full mt-8 text-slate-400 font-bold">СКАСУВАТИ</button>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className={`fixed top-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-3xl text-white font-black shadow-2xl z-[1000] animate-in slide-in-from-top-10 flex items-center gap-3 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>
                            {notification.msg}
                        </div>
                    )}
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
