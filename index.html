<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СИНТЕЗ - Elite Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Нові шрифти з макетів -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">

    <style>
        /* --- ЗАГАЛЬНІ СТИЛІ --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            font-family: 'Cormorant Garamond', serif;
            background-color: #0d1f14; /* Темно-зелений фон столу */
            background-image: radial-gradient(#1a3c28 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ecfdf5;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- ЗМІННІ КОЛЬОРІВ ЕЛЕМЕНТІВ (З файлу Element) --- */
        :root {
            /* O - Оксиген */
            --main-O: #B71C1C; 
            --bg-O: radial-gradient(circle, #FFEBEE 0%, #EF9A9A 150%);
            /* H - Гідроген */
            --main-H: #37474F; 
            --bg-H: radial-gradient(circle, #E3F2FD 0%, #90A4AE 150%);
            /* C - Карбон */
            --main-C: #000000; 
            --bg-C: radial-gradient(circle, #E0E0E0 0%, #616161 150%);
            /* Na - Натрій */
            --main-Na: #4A148C; 
            --bg-Na: radial-gradient(circle, #F3E5F5 0%, #CE93D8 150%);
            /* Ca - Кальцій */
            --main-Ca: #BF360C; 
            --bg-Ca: radial-gradient(circle, #FFF3E0 0%, #FFCC80 150%);
            /* Cl - Хлор */
            --main-Cl: #1B5E20; 
            --bg-Cl: radial-gradient(circle, #E8F5E9 0%, #A5D6A7 150%);
            /* N - Нітроген */
            --main-N: #1A237E; 
            --bg-N: radial-gradient(circle, #E8EAF6 0%, #9FA8DA 150%);
            /* S - Сульфур */
            --main-S: #F57F17; 
            --bg-S: radial-gradient(circle, #FFFDE7 0%, #FFF59D 150%);
            /* Si - Силіцій */
            --main-Si: #3E2723; 
            --bg-Si: radial-gradient(circle, #EFEBE9 0%, #BCAAA4 150%);

            /* Молекули */
            --gold-front: radial-gradient(circle at center, #fffdf5 0%, #fceeb5 100%);
            --green-classic: #006400;
        }

        /* --- СТИЛІ КАРТКИ ЕЛЕМЕНТА --- */
        .card-element {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.4);
            transition: transform 0.2s;
            background: #fff; /* Fallback */
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .card-element .pattern-bg {
            position: absolute; inset: 0; opacity: 0.15;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0 L20 5 L20 15 L10 20 L0 15 L0 5 Z' fill='none' stroke='%23000' stroke-width='1'/%3E%3C/svg%3E");
            background-size: 30px 30px;
        }

        .card-element .texture {
            position: absolute; inset: 0; opacity: 0.4; mix-blend-mode: multiply;
            background-image: url("https://www.transparenttextures.com/patterns/stardust.png");
        }

        .card-element .card-border-inner {
            position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 2px solid rgba(255,255,255,0.6);
            border-radius: 8px; pointer-events: none;
        }

        .corner-circle {
            position: absolute; width: 24px; height: 24px;
            background: rgba(255,255,255,0.95);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 10px;
            z-index: 10;
        }
        .tl { top: 8px; left: 8px; }
        .tr { top: 8px; right: 8px; }
        .bl { bottom: 8px; left: 8px; }
        .br { bottom: 8px; right: 8px; }

        .center-ring {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; aspect-ratio: 1/1;
            background: rgba(255,255,255,0.85);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5;
            backdrop-filter: blur(2px);
        }

        .symbol-main {
            font-family: 'Playfair Display', serif;
            font-weight: 900; font-size: 2.2rem; line-height: 1;
        }
        
        .name-ua {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            margin-top: 2px;
        }

        /* --- СТИЛІ КАРТКИ МОЛЕКУЛИ --- */
        .card-molecule {
            position: relative;
            background: var(--gold-front);
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex; flex-direction: column;
            border: 1px solid #c9b675;
        }

        .card-molecule .pattern-bg {
            position: absolute; inset: 0;
            background-image: radial-gradient(#d4b062 1px, transparent 1px);
            background-size: 10px 10px; opacity: 0.2;
        }

        .card-molecule .card-border-double {
            position: absolute; inset: 4px;
            border: 3px double var(--green-classic);
            border-radius: 8px; pointer-events: none; z-index: 2;
        }

        .mol-points {
            position: absolute; top: 0; right: 0;
            background: var(--green-classic); color: #fffdf5;
            font-family: 'Montserrat', sans-serif; font-weight: 900;
            font-size: 0.8rem; padding: 4px 10px;
            border-bottom-left-radius: 12px;
            border-left: 2px solid #fffdf5; border-bottom: 2px solid #fffdf5;
            z-index: 10; box-shadow: -2px 2px 5px rgba(0,0,0,0.2);
        }

        .mol-formula {
            margin-top: 25px;
            font-family: 'Playfair Display', serif;
            font-weight: 900; font-size: 2rem;
            color: #1a1a1a; text-align: center;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
            z-index: 5;
        }

        .mol-names {
            text-align: center; margin-top: auto; margin-bottom: 10px; z-index: 5;
        }
        .mol-name-trivial {
            font-family: 'Montserrat', sans-serif; font-weight: 800;
            text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em;
            color: #3e2723;
        }

        .mol-recipe {
            background: rgba(0, 100, 0, 0.08);
            padding: 6px;
            display: flex; justify-content: center; gap: 4px;
            border-top: 1px solid rgba(0, 100, 0, 0.2);
            z-index: 5;
        }
        .atom-dot {
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 8px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* --- АНІМАЦІЇ UI --- */
        #error-overlay {
            display: none; position: fixed; inset: 0; background: white; z-index: 9999; padding: 20px; color: red;
        }
    </style>
</head>
<body>
    <div id="error-overlay">
        <h2 class="text-xl font-bold mb-2">⚠️ Критична помилка:</h2>
        <pre id="error-msg" class="whitespace-pre-wrap font-mono text-xs"></pre>
        <button onclick="window.location.reload()" class="mt-4 bg-green-700 text-white px-4 py-2 rounded">Перезавантажити гру</button>
    </div>
    
    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-msg').innerText = `${msg}\nLocation: ${line}:${col}\n${error?.stack}`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, 
            arrayUnion, runTransaction, increment 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // Icons
        import { 
            FlaskConical, ArrowRightLeft, Crown, LogOut, Loader2, X, 
            History, Trash2, RefreshCcw, CheckCircle2, Menu
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- КОНФІГУРАЦІЯ FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEownlzJ0AqrnAku7Cw208N2DRLQHdD6Y",
            authDomain: "synthesis-game-f9684.firebaseapp.com",
            projectId: "synthesis-game-f9684",
            storageBucket: "synthesis-game-f9684.firebasestorage.app",
            messagingSenderId: "257683012244",
            appId: "1:257683012244:web:c7aee7e27c929ceb5b9281"
        };

        // Ініціалізація
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase init error", e);
        }

        const appId = 'synthesis-game';
        const WINNING_SCORE = 50;

        // --- ДОВІДНИК ЕЛЕМЕНТІВ ---
        // Використовуємо CSS змінні для кольорів з вашого файлу
        const ELEMENTS = {
            'H':  { m: 1.01,  name: 'Гідроген' },
            'O':  { m: 16.00, name: 'Оксиген' },
            'C':  { m: 12.01, name: 'Карбон' },
            'N':  { m: 14.01, name: 'Нітроген' },
            'Na': { m: 22.99, name: 'Натрій' },
            'Cl': { m: 35.45, name: 'Хлор' },
            'Ca': { m: 40.08, name: 'Кальцій' },
            'S':  { m: 32.07, name: 'Сульфур' },
            'Si': { m: 28.09, name: 'Силіцій' },
        };

        const ELEMENT_DISTRIBUTION = {
            'H': 24, 'O': 34, 'C': 12, 'Na': 10, 'Cl': 7, 'Ca': 8, 'N': 7, 'S': 6, 'Si': 4
        };

        const MOLECULES_LIST = [
            // Прості
            { id: 'h2o',     f: 'H₂O',      name: 'Вода',              vp: 3, count: 6, req: { 'H': 2, 'O': 1 } },
            { id: 'co',      f: 'CO',       name: 'Чадний газ',        vp: 4, count: 4, req: { 'C': 1, 'O': 1 } },
            { id: 'hcl',     f: 'HCl',      name: 'Хлоридна к-та',     vp: 6, count: 3, req: { 'H': 1, 'Cl': 1 } },
            { id: 'cao',     f: 'CaO',      name: 'Негашене вапно',    vp: 4, count: 3, req: { 'Ca': 1, 'O': 1 } },
            // Середні
            { id: 'co2',     f: 'CO₂',      name: 'Вуглекислий газ',   vp: 5, count: 5, req: { 'C': 1, 'O': 2 } },
            { id: 'nacl',    f: 'NaCl',     name: 'Кухонна сіль',      vp: 8, count: 4, req: { 'Na': 1, 'Cl': 1 } },
            { id: 'naoh',    f: 'NaOH',     name: 'Каустична сода',    vp: 5, count: 3, req: { 'Na': 1, 'O': 1, 'H': 1 } },
            { id: 'nh3',     f: 'NH₃',      name: 'Аміак',             vp: 8, count: 2, req: { 'N': 1, 'H': 3 } },
            { id: 'h2o2',    f: 'H₂O₂',     name: 'Перекис водню',     vp: 4, count: 2, req: { 'H': 2, 'O': 2 } },
            { id: 'so2',     f: 'SO₂',      name: 'Сірчистий газ',     vp: 4, count: 2, req: { 'S': 1, 'O': 2 } },
            { id: 'sio2',    f: 'SiO₂',     name: 'Пісок',             vp: 10, count: 2, req: { 'Si': 1, 'O': 2 } },
            // Складні
            { id: 'caoh2',   f: 'Ca(OH)₂',  name: 'Гашене вапно',      vp: 7, count: 2, req: { 'Ca': 1, 'O': 2, 'H': 2 } },
            { id: 'h2so4',   f: 'H₂SO₄',    name: 'Сульфатна к-та',    vp: 12, count: 1, req: { 'H': 2, 'S': 1, 'O': 4 } },
            { id: 'caco3',   f: 'CaCO₃',    name: 'Крейда',            vp: 9, count: 3, req: { 'Ca': 1, 'C': 1, 'O': 3 } },
            { id: 'nahco3',  f: 'NaHCO₃',   name: 'Харчова сода',      vp: 10, count: 3, req: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 } },
            { id: 'na2co3',  f: 'Na₂CO₃',   name: 'Кальцинована сода', vp: 12, count: 3, req: { 'Na': 2, 'C': 1, 'O': 3 } },
        ];

        // --- ЛОГІКА ТА УТИЛІТИ ---

        const shuffleArray = (array) => {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const generateElementDeck = () => {
            let deck = [];
            Object.entries(ELEMENT_DISTRIBUTION).forEach(([el, count]) => {
                for (let i = 0; i < count; i++) deck.push(el);
            });
            return shuffleArray(deck);
        };

        const generateMoleculeDeck = () => {
            let deck = [];
            MOLECULES_LIST.forEach(mol => {
                for (let i = 0; i < (mol.count || 1); i++) {
                    deck.push({ ...mol, uniqueId: `${mol.id}_${Math.random().toString(36).substr(2, 8)}` });
                }
            });
            return shuffleArray(deck);
        };

        const checkRecipe = (hand, recipe) => {
            const handCounts = {};
            hand.forEach(el => handCounts[el] = (handCounts[el] || 0) + 1);
            
            for (const [el, needed] of Object.entries(recipe)) {
                if (!handCounts[el] || handCounts[el] < needed) return false;
            }
            return true;
        };

        const getAtomsList = (req) => {
            let list = [];
            Object.entries(req).forEach(([el, count]) => {
                for(let i=0; i<count; i++) list.push(el);
            });
            return list;
        };

        // --- НОВІ КОМПОНЕНТИ (Дизайн Catan Style) ---

        // 1. Картка Елемента
        const ElementCard = ({ type, onClick, selected = false, style, overlap = false, mini = false }) => {
            const data = ELEMENTS[type] || { m: '?', name: type };

            // Визначаємо стилі на основі типу елемента (CSS змінні)
            const cardStyle = {
                background: `var(--bg-${type})`,
                color: `var(--main-${type})`
            };
            
            // Стиль для кутових цифр (вони мають бути того ж кольору, що й головний текст)
            const textStyle = { color: `var(--main-${type})` };

            if (mini) {
                return (
                    <div 
                        onClick={onClick} 
                        className={`
                            relative w-12 h-16 rounded-md border shadow-sm flex flex-col items-center justify-center cursor-pointer transition-transform
                            ${selected ? 'ring-2 ring-yellow-500 scale-110 z-10' : 'hover:scale-105'}
                        `}
                        style={cardStyle}
                    >
                        <span className="font-bold font-serif text-lg">{type}</span>
                    </div>
                );
            }

            return (
                <div 
                    onClick={onClick}
                    style={{...style, ...cardStyle}}
                    className={`
                        card-element
                        relative w-24 h-36 flex-shrink-0 cursor-pointer select-none
                        ${selected ? '-translate-y-8 z-30 ring-4 ring-yellow-400 border-yellow-500 shadow-yellow-500/50' : 'hover:-translate-y-4 hover:z-20'}
                        ${overlap ? '-ml-12 hover:ml-0' : ''}
                    `}
                >
                    <div className="pattern-bg"></div>
                    <div className="texture"></div>
                    <div className="card-border-inner"></div>

                    {/* Кутові індикатори */}
                    <div className="corner-circle tl" style={textStyle}>{type}</div>
                    <div className="corner-circle tr" style={textStyle}>{data.m}</div>
                    <div className="corner-circle bl" style={textStyle}>{data.m}</div>
                    <div className="corner-circle br" style={textStyle}>{type}</div>

                    {/* Центр */}
                    <div className="center-ring" style={{color: `var(--main-${type})`}}>
                        <div className="symbol-main">{type}</div>
                        <div className="name-ua">{data.name}</div>
                    </div>
                </div>
            );
        };

        // 2. Картка Молекули
        const MoleculeCard = ({ mol, canBuy, onBuy }) => {
            const atoms = getAtomsList(mol.req);
            
            return (
                <div 
                    onClick={() => canBuy && onBuy(mol)}
                    className={`
                        card-molecule
                        w-[45%] sm:w-40 min-h-[200px] sm:min-h-[220px]
                        transition-all duration-300
                        ${canBuy ? 'scale-105 cursor-pointer z-10 shadow-[0_0_20px_rgba(255,215,0,0.6)] ring-2 ring-yellow-400' : 'opacity-95'}
                    `}
                >
                    <div className="pattern-bg"></div>
                    <div className="card-border-double"></div>

                    {/* Бали VP */}
                    <div className="mol-points">{mol.vp} VP</div>

                    {/* Формула */}
                    <div className="mol-formula">
                        {mol.f}
                    </div>

                    {/* Назва */}
                    <div className="mol-names">
                        <div className="mol-name-trivial">{mol.name}</div>
                    </div>

                    {/* Рецепт (Атоми знизу) */}
                    <div className="mol-recipe">
                        {atoms.map((el, i) => (
                            <div 
                                key={i} 
                                className="atom-dot"
                                style={{
                                    background: `var(--bg-${el})`,
                                    color: `var(--main-${el})`,
                                    borderColor: `var(--main-${el})`
                                }}
                            >
                                {el}
                            </div>
                        ))}
                    </div>

                    {/* Оверлей покупки */}
                    {canBuy && (
                        <div className="absolute inset-0 bg-green-900/20 flex items-center justify-center backdrop-blur-[1px] z-20 animate-pulse">
                            <div className="bg-green-700 text-white px-4 py-2 rounded-full shadow-xl font-black text-xs uppercase tracking-widest flex items-center gap-2 border-2 border-green-500">
                                <FlaskConical size={14}/> СИНТЕЗУВАТИ
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 3. Модальне вікно (Без змін)
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-[#fcfcfc] rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border-2 border-green-800">
                        <div className="bg-green-900 px-6 py-4 border-b border-green-800 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-yellow-50 font-serif">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-green-800 rounded-full text-green-200 transition-colors">
                                <X size={24}/>
                            </button>
                        </div>
                        <div className="p-6 bg-[#f0fdf4]">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ГОЛОВНИЙ КЛАС ГРИ ---

        const SynthesisGame = () => {
            // Стан авторизації та кімнати
            const [user, setUser] = useState(null);
            const [gameId, setGameId] = useState(localStorage.getItem('lastGameId') || '');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [playerName, setPlayerName] = useState(localStorage.getItem('playerName') || '');
            
            // Стан інтерфейсу
            const [selectedCards, setSelectedCards] = useState([]); // Індекси карт в руці
            const [notification, setNotification] = useState(null);
            const [targetGameId, setTargetGameId] = useState('');
            
            // Стан торгівлі
            const [isTradeModalOpen, setTradeModalOpen] = useState(false);
            const [tradeTab, setTradeTab] = useState('bank'); // 'bank' | 'player'
            const [tradeOffer, setTradeOffer] = useState({ give: [], want: '' });

            // 1. Авторизація
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Error:", error);
                        showNotification('error', "Помилка входу в систему");
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, []);

            // 2. Синхронізація з БД
            useEffect(() => {
                if (!gameId || !db) return;
                
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const unsubscribe = onSnapshot(gameRef, (snap) => {
                    if (snap.exists()) {
                        setGameData(snap.data());
                    } else {
                        setGameData(null);
                        if (gameId) showNotification('error', 'Кімнату не знайдено');
                        setGameId('');
                    }
                }, (error) => {
                    console.error("Sync Error:", error);
                    showNotification('error', 'Втрачено зв\'язок з сервером');
                });

                return () => unsubscribe();
            }, [gameId]);

            // --- Допоміжні змінні ---
            const myIndex = gameData?.players.findIndex(p => p.uid === user?.uid) ?? -1;
            const myPlayer = myIndex !== -1 ? gameData.players[myIndex] : null;
            const isMyTurn = gameData?.status === 'playing' && gameData?.turnIndex === myIndex;
            const isHost = gameData?.players[0].uid === user?.uid;
            
            const turnPhase = gameData?.turnPhase; // 'draw', 'action', 'discard_force'
            const isDiscardPhase = turnPhase === 'discard_force' && isMyTurn;
            const cardsToDiscard = isDiscardPhase && myPlayer ? Math.max(0, myPlayer.hand.length - 10) : 0;

            // --- Функції сповіщень ---
            const showNotification = (type, msg) => {
                setNotification({ type, msg });
                setTimeout(() => setNotification(null), 3000);
            };

            // --- Ігрові Дії ---

            const createGame = async () => {
                if (!playerName.trim()) return showNotification('error', "Введіть ваше ім'я!");
                setLoading(true);
                
                localStorage.setItem('playerName', playerName);
                const newGameId = Math.random().toString(36).substring(2, 6).toUpperCase();
                
                const molDeck = generateMoleculeDeck();
                const initialMarket = molDeck.splice(0, 4); 

                const initialData = {
                    id: newGameId,
                    status: 'waiting', 
                    players: [{
                        uid: user.uid,
                        name: playerName,
                        hand: [],
                        score: 0,
                        molecules: [] // ids of molecules
                    }],
                    elementDeck: generateElementDeck(),
                    moleculeDeck: molDeck,
                    market: initialMarket,
                    discardPile: [], 
                    turnIndex: 0,
                    turnPhase: 'draw', 
                    activeTrade: null,
                    logs: [{ text: `Алхімік ${playerName} відкрив лабораторію`, time: Date.now() }]
                };

                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', newGameId), initialData);
                    setGameId(newGameId);
                    localStorage.setItem('lastGameId', newGameId);
                } catch (e) {
                    showNotification('error', 'Помилка створення гри');
                }
                setLoading(false);
            };

            const joinGame = async (code) => {
                if (!playerName.trim()) return showNotification('error', "Введіть ваше ім'я!");
                setLoading(true);
                localStorage.setItem('playerName', playerName);

                const codeUpper = code.toUpperCase().trim();
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', codeUpper);

                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(gameRef);
                        if (!sfDoc.exists()) throw "Кімнати не існує";
                        
                        const data = sfDoc.data();
                        if (data.status !== 'waiting') throw "Гра вже почалась";
                        if (data.players.length >= 4) throw "Кімната переповнена";
                        if (data.players.some(p => p.uid === user.uid)) return; // Вже в грі

                        const newPlayer = { uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] };
                        transaction.update(gameRef, {
                            players: arrayUnion(newPlayer),
                            logs: arrayUnion({ text: `${playerName} приєднався до експерименту`, time: Date.now() })
                        });
                    });
                    setGameId(codeUpper);
                    localStorage.setItem('lastGameId', codeUpper);
                } catch (e) {
                    showNotification('error', typeof e === 'string' ? e : e.message);
                }
                setLoading(false);
            };

            const startGame = async () => {
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const newDeck = [...gameData.elementDeck];
                
                // Роздача по 5 карт
                const updatedPlayers = gameData.players.map(p => ({ 
                    ...p, 
                    hand: newDeck.splice(0, 5) 
                }));

                await updateDoc(gameRef, {
                    status: 'playing', 
                    elementDeck: newDeck, 
                    players: updatedPlayers, 
                    turnPhase: 'draw',
                    logs: arrayUnion({ text: 'Експеримент почався! Роздано по 5 елементів.', time: Date.now() })
                });
            };

            const drawCards = async () => {
                if (!isMyTurn || turnPhase !== 'draw') return;
                
                let newDeck = [...gameData.elementDeck];
                if (newDeck.length < 2) {
                     showNotification('error', 'Колода елементів вичерпана!'); 
                     return; 
                }

                const drawn = newDeck.splice(0, 2);
                const updatedPlayers = [...gameData.players];
                const newHand = [...myPlayer.hand, ...drawn];
                updatedPlayers[myIndex].hand = newHand;
                
                const nextPhase = newHand.length > 10 ? 'discard_force' : 'action';

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    elementDeck: newDeck,
                    players: updatedPlayers,
                    turnPhase: nextPhase,
                    logs: arrayUnion({ text: `${myPlayer.name} отримав нові елементи`, time: Date.now() })
                });
            };

            const discardCards = async () => {
                if (selectedCards.length !== cardsToDiscard) {
                    showNotification('error', `Необхідно скинути рівно ${cardsToDiscard} карт!`);
                    return;
                }
                
                let newHand = [...myPlayer.hand];
                selectedCards.sort((a,b) => b-a).forEach(idx => {
                    newHand.splice(idx, 1);
                });
                
                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    turnPhase: 'action', 
                    logs: arrayUnion({ text: `${myPlayer.name} очистив інвентар`, time: Date.now() })
                });
                setSelectedCards([]);
            };

            const synthesizeMolecule = async (molecule) => {
                if (!checkRecipe(myPlayer.hand, molecule.req)) return;

                let newHand = [...myPlayer.hand];
                Object.entries(molecule.req).forEach(([el, count]) => {
                    for(let i=0; i<count; i++) {
                        const idx = newHand.indexOf(el);
                        if (idx > -1) {
                            newHand.splice(idx, 1);
                        }
                    }
                });

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex] = {
                    ...myPlayer,
                    hand: newHand,
                    molecules: [...myPlayer.molecules, molecule.id],
                    score: myPlayer.score + molecule.vp
                };

                const newMarket = [...gameData.market];
                const marketIndex = newMarket.findIndex(m => m.uniqueId === molecule.uniqueId);
                newMarket.splice(marketIndex, 1);
                
                const newDeck = [...gameData.moleculeDeck];
                if (newDeck.length > 0) {
                    newMarket.push(newDeck.shift());
                }

                const status = updatedPlayers[myIndex].score >= WINNING_SCORE ? 'finished' : 'playing';

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    status,
                    market: newMarket,
                    moleculeDeck: newDeck,
                    logs: arrayUnion({ text: `${myPlayer.name} синтезував ${molecule.name} (+${molecule.vp} VP)`, time: Date.now() })
                });
            };

            const endTurn = async () => {
                const nextIndex = (gameData.turnIndex + 1) % gameData.players.length;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    turnIndex: nextIndex,
                    turnPhase: 'draw',
                    activeTrade: null, 
                    logs: arrayUnion({ text: `Хід переходить до ${gameData.players[nextIndex].name}`, time: Date.now() })
                });
            };

            // --- ТОРГІВЛЯ ---

            const executeBankTrade = async () => {
                if (selectedCards.length !== 3) {
                    showNotification('error', "Оберіть рівно 3 карти для обміну!");
                    return;
                }
                const firstCard = myPlayer.hand[selectedCards[0]];
                const allSame = selectedCards.every(idx => myPlayer.hand[idx] === firstCard);
                
                if (!allSame) {
                    showNotification('error', "Карти повинні бути однаковими для обміну з банком!");
                    return;
                }
                
                if (!tradeOffer.want) {
                    showNotification('error', "Оберіть, що хочете отримати!");
                    return;
                }

                let newHand = [...myPlayer.hand];
                selectedCards.sort((a,b) => b-a).forEach(idx => newHand.splice(idx, 1));
                newHand.push(tradeOffer.want);

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    logs: arrayUnion({ text: `${myPlayer.name} обміняв 3 ${firstCard} на ${tradeOffer.want}`, time: Date.now() })
                });
                
                setTradeModalOpen(false);
                setSelectedCards([]);
                setTradeOffer({ give: [], want: '' });
            };

            const createPlayerTrade = async () => {
                if (selectedCards.length === 0) {
                    showNotification('error', "Оберіть карти, які віддаєте!");
                    return;
                }
                if (!tradeOffer.want) {
                    showNotification('error', "Оберіть карту, яку хочете!");
                    return;
                }

                const giveCards = selectedCards.map(idx => myPlayer.hand[idx]);
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    activeTrade: {
                        initiator: user.uid,
                        give: giveCards,
                        want: tradeOffer.want,
                        giveIndices: selectedCards 
                    },
                    logs: arrayUnion({ text: `${myPlayer.name} пропонує обмін: ${giveCards.join(', ')} на ${tradeOffer.want}`, time: Date.now() })
                });
                setTradeModalOpen(false);
                setSelectedCards([]);
            };

            const acceptActiveTrade = async () => {
                const trade = gameData.activeTrade;
                if (!trade) return;

                const myRequiredCardIndex = myPlayer.hand.indexOf(trade.want);
                if (myRequiredCardIndex === -1) {
                    showNotification('error', `У вас немає елементу ${trade.want} для обміну!`);
                    return;
                }

                const initiatorIndex = gameData.players.findIndex(p => p.uid === trade.initiator);
                const initiator = gameData.players[initiatorIndex];

                const newMyHand = [...myPlayer.hand];
                const newInitHand = [...initiator.hand];

                newMyHand.splice(myRequiredCardIndex, 1);
                newInitHand.push(trade.want);

                trade.give.forEach(cardType => {
                    const idx = newInitHand.indexOf(cardType);
                    if (idx > -1) newInitHand.splice(idx, 1);
                    newMyHand.push(cardType);
                });

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newMyHand;
                updatedPlayers[initiatorIndex].hand = newInitHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    activeTrade: null,
                    logs: arrayUnion({ text: `Обмін між ${initiator.name} та ${myPlayer.name} успішний!`, time: Date.now() })
                });
            };

            const cancelActiveTrade = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    activeTrade: null,
                    logs: arrayUnion({ text: `${myPlayer.name} скасував пропозицію обміну`, time: Date.now() })
                });
            };

            const handleCardClick = (idx) => {
                if (!isMyTurn) return;
                
                if (turnPhase === 'discard_force' || turnPhase === 'action') {
                    setSelectedCards(prev => prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]);
                }
            };

            // --- РЕНДЕРИНГ UI ---

            if (loading) {
                return <div className="h-screen w-full bg-[#0d1f14] flex items-center justify-center"><Loader2 className="animate-spin text-yellow-500" size={64}/></div>;
            }

            // 1. ЕКРАН ЛОБІ
            if (!gameData) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-cover bg-center">
                        <div className="bg-[#0d1f14]/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-md border-2 border-yellow-700">
                            <div className="text-center mb-8">
                                <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-2 drop-shadow-lg" style={{fontFamily: 'Playfair Display'}}>СИНТЕЗ</h1>
                                <p className="text-green-200 font-serif tracking-widest text-sm uppercase">Elite Chemistry</p>
                            </div>
                            
                            <div className="space-y-4">
                                <input 
                                    type="text" 
                                    placeholder="Ім'я Алхіміка" 
                                    className="w-full p-4 bg-[#06120a] border-2 border-green-800 rounded-xl focus:border-yellow-500 focus:outline-none transition-colors text-yellow-100 font-bold text-lg text-center placeholder-green-800 shadow-inner font-serif"
                                    value={playerName}
                                    onChange={e => setPlayerName(e.target.value)}
                                />
                                
                                <button onClick={createGame} className="group w-full py-4 bg-gradient-to-r from-green-800 to-green-700 hover:from-green-700 hover:to-green-600 text-white rounded-xl font-bold text-lg shadow-lg border-b-4 border-green-950 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 font-serif tracking-widest">
                                    <FlaskConical className="group-hover:rotate-12 transition-transform" /> СТВОРИТИ
                                </button>
                                
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="КОД" 
                                        className="w-2/3 p-4 bg-[#06120a] border-2 border-green-800 rounded-xl font-mono text-center uppercase text-yellow-100 font-bold tracking-[0.2em] outline-none focus:border-yellow-500"
                                        value={targetGameId}
                                        onChange={e => setTargetGameId(e.target.value)}
                                    />
                                    <button onClick={() => joinGame(targetGameId)} className="flex-1 bg-yellow-700 hover:bg-yellow-600 text-white rounded-xl font-bold shadow-lg border-b-4 border-yellow-900 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center">
                                        <ArrowRightLeft />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 2. ЕКРАН ОЧІКУВАННЯ
            if (gameData.status === 'waiting') {
                return (
                    <div className="min-h-screen bg-[#0d1f14] flex flex-col items-center justify-center p-4">
                        <div className="bg-[#1a3c28] p-8 rounded-3xl shadow-2xl w-full max-w-lg text-center border-4 border-yellow-600 relative overflow-hidden">
                            <h2 className="text-green-300 font-bold mb-2 uppercase tracking-wide text-xs">Код доступу</h2>
                            <div className="text-6xl font-mono font-black text-yellow-400 tracking-[0.15em] mb-8 bg-[#0d1f14] py-6 rounded-xl border border-green-800 select-all shadow-inner">
                                {gameId}
                            </div>
                            
                            <div className="space-y-3 mb-8 text-left">
                                {gameData.players.map((p, i) => (
                                    <div key={i} className="flex items-center gap-4 p-4 bg-[#0d1f14] border border-green-800 rounded-2xl shadow-lg">
                                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500 to-yellow-700 flex items-center justify-center text-black font-black text-xl shadow-md border-2 border-yellow-300 font-serif">
                                            {p.name[0]}
                                        </div>
                                        <div className="font-bold text-xl text-green-100 font-serif">{p.name}</div>
                                        {i === 0 && <Crown className="ml-auto text-yellow-400 drop-shadow-md" />}
                                    </div>
                                ))}
                                {[...Array(4 - gameData.players.length)].map((_, i) => (
                                    <div key={i} className="p-4 border-2 border-dashed border-green-900 rounded-2xl flex items-center justify-center text-green-800 font-bold uppercase tracking-wider font-serif">
                                        Очікування...
                                    </div>
                                ))}
                            </div>

                            {isHost ? (
                                <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black rounded-xl font-black text-xl shadow-[0_0_20px_rgba(234,179,8,0.4)] transition-all active:scale-95 flex items-center justify-center gap-3 font-serif">
                                    ПОЧАТИ ГРУ
                                </button>
                            ) : (
                                <div className="flex items-center justify-center gap-3 text-green-400 font-bold animate-pulse p-4">
                                    <Loader2 className="animate-spin"/> Очікування хоста...
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // 3. ОСНОВНИЙ ЕКРАН ГРИ
            return (
                <div className="h-screen flex flex-col relative overflow-hidden">
                    
                    {/* ВЕРХНЯ ПАНЕЛЬ */}
                    <header className="bg-[#0f291a] shadow-xl z-50 shrink-0 border-b border-green-800">
                        <div className="flex justify-between items-center px-4 py-2 bg-[#06120a]/50 backdrop-blur">
                            <div className="flex items-center gap-2">
                                <span className="text-yellow-500 font-black font-serif tracking-widest text-lg">СИНТЕЗ</span>
                                <span className="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded border border-green-700">
                                    Раунд {Math.floor(gameData.turnIndex / gameData.players.length) + 1}
                                </span>
                            </div>
                            <button onClick={() => {if(confirm('Вийти?')) setGameId('')}} className="text-green-600 hover:text-red-400">
                                <LogOut size={20}/>
                            </button>
                        </div>

                        {/* Список гравців */}
                        <div className="flex overflow-x-auto p-3 gap-3 scrollbar-hide bg-[#0d1f14]">
                            {gameData.players.map((p, i) => {
                                const isActive = gameData.turnIndex === i;
                                const isMe = p.uid === user.uid;
                                return (
                                    <div key={i} className={`
                                        flex-shrink-0 flex items-center gap-3 px-4 py-2 rounded-lg border transition-all min-w-[140px]
                                        ${isActive ? 'bg-yellow-900/40 border-yellow-600 shadow-md' : 'bg-[#06120a] border-green-900 opacity-60'}
                                    `}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold font-serif ${isActive ? 'bg-yellow-500 text-black' : 'bg-green-800 text-green-300'}`}>
                                            {p.name[0]}
                                        </div>
                                        <div className="flex flex-col">
                                            <span className={`text-xs font-bold leading-none mb-1 font-serif ${isActive ? 'text-yellow-100' : 'text-green-500'}`}>
                                                {p.name}
                                            </span>
                                            <div className="flex gap-2 text-[10px] font-mono">
                                                <span className="text-yellow-500">VP: {p.score}</span>
                                                <span className="text-green-400">Card: {p.hand.length}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </header>

                    {/* АЛЕРТ ТОРГІВЛІ */}
                    {gameData.activeTrade && gameData.activeTrade.initiator !== user.uid && (
                        <div className="absolute top-32 left-0 right-0 z-[60] px-4 animate-in slide-in-from-top duration-500">
                            <div className="bg-[#f0fdf4] border-l-8 border-green-600 rounded-lg p-4 shadow-2xl flex flex-col items-center gap-3 text-black">
                                <div className="font-bold text-center text-sm font-serif">
                                    <span className="text-green-800 uppercase text-xs block mb-1">Пропозиція обміну</span>
                                    {gameData.players.find(p=>p.uid===gameData.activeTrade.initiator)?.name} пропонує <br/>
                                    <span className="font-black bg-yellow-200 px-2 rounded mx-1">{gameData.activeTrade.give.join(', ')}</span> 
                                    за 
                                    <span className="font-black bg-green-200 px-2 rounded mx-1">{gameData.activeTrade.want}</span>
                                </div>
                                <button onClick={acceptActiveTrade} className="bg-green-700 text-white px-6 py-2 rounded-full font-bold shadow-lg text-xs uppercase tracking-widest">
                                    Прийняти
                                </button>
                            </div>
                        </div>
                    )}

                    {/* ІГРОВЕ ПОЛЕ */}
                    <div className="flex-1 overflow-y-auto p-4 pb-60 scrollbar-hide relative">
                        <div className="flex flex-wrap gap-4 justify-center pb-20">
                            {gameData.market.map(mol => (
                                <MoleculeCard 
                                    key={mol.uniqueId} 
                                    mol={mol} 
                                    canBuy={isMyTurn && turnPhase === 'action' && checkRecipe(myPlayer.hand, mol.req)}
                                    onBuy={synthesizeMolecule}
                                />
                            ))}
                            {gameData.market.length === 0 && (
                                <div className="text-green-600 italic border border-green-800 px-8 py-4 rounded-xl">Ринок пустий</div>
                            )}
                        </div>

                        {/* ЛОГИ */}
                        <div className="fixed bottom-[240px] right-4 w-48 bg-[#06120a]/80 border border-green-800 rounded-lg p-2 max-h-32 overflow-y-auto shadow-lg backdrop-blur text-[10px]">
                            {gameData.logs.slice().reverse().map((log, i) => (
                                <div key={i} className="mb-1 text-green-300 font-serif border-b border-green-900/50 pb-1 last:border-0">
                                    <span className="opacity-50 mr-2">{new Date(log.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                                    {log.text}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* СПОВІЩЕННЯ */}
                    {notification && (
                        <div className={`fixed bottom-1/2 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl text-white font-bold z-[100] animate-in slide-in-from-bottom-4 flex items-center gap-3 text-sm whitespace-nowrap border-2 font-serif
                            ${notification.type === 'error' ? 'bg-red-900 border-red-500' : 'bg-green-800 border-green-500'}
                        `}>
                            {notification.msg}
                        </div>
                    )}

                    {/* НИЖНЯ ПАНЕЛЬ */}
                    <div className="absolute bottom-0 left-0 w-full z-40 flex flex-col justify-end pointer-events-none">
                        
                        {/* КНОПКИ ДІЙ */}
                        <div className="flex justify-center mb-4 px-4 gap-3 pointer-events-auto">
                            {isMyTurn && (
                                <>
                                    {turnPhase === 'draw' && (
                                        <button onClick={drawCards} className="bg-yellow-600 hover:bg-yellow-500 text-black px-6 py-3 rounded-full font-black shadow-[0_0_20px_rgba(234,179,8,0.4)] flex items-center gap-2 animate-bounce font-serif tracking-widest text-sm border-2 border-yellow-400">
                                            ДОСЛІДИТИ (+2)
                                        </button>
                                    )}
                                    
                                    {turnPhase === 'action' && (
                                        <div className="flex gap-2 bg-[#06120a]/90 backdrop-blur p-2 rounded-full border border-green-600 shadow-xl">
                                            <button 
                                                onClick={() => { setTradeModalOpen(true); setSelectedCards([]); setTradeOffer({ give: [], want: '' }); }} 
                                                className="bg-purple-800 text-purple-100 px-4 py-2 rounded-full font-bold text-xs uppercase hover:bg-purple-700"
                                            >
                                                ОБМІН
                                            </button>
                                            <button 
                                                onClick={endTurn} 
                                                className="bg-green-800 text-green-100 px-4 py-2 rounded-full font-bold text-xs uppercase hover:bg-green-700 border border-green-600"
                                            >
                                                ЗАВЕРШИТИ
                                            </button>
                                        </div>
                                    )}

                                    {isDiscardPhase && (
                                        <button onClick={discardCards} className="bg-red-700 text-white px-6 py-3 rounded-full font-bold shadow-lg animate-pulse hover:bg-red-600 text-xs uppercase tracking-widest border-2 border-red-500">
                                            СКИНУТИ {cardsToDiscard - selectedCards.length}
                                        </button>
                                    )}
                                </>
                            )}
                        </div>

                        {/* РУКА */}
                        <div className="bg-[#1a3c28] w-full rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.6)] pt-3 pb-8 px-2 relative pointer-events-auto border-t-4 border-yellow-600">
                            <div className="w-16 h-1 bg-green-700 rounded-full mx-auto mb-3"></div>
                            
                            <div className="overflow-x-auto overflow-y-visible flex justify-center px-4 py-4 min-h-[160px] scrollbar-hide pb-10">
                                <div className="flex -space-x-10 sm:-space-x-6 px-8 items-end">
                                    {myPlayer?.hand
                                        .map((card, idx) => ({ card, idx }))
                                        .sort((a, b) => a.card.localeCompare(b.card))
                                        .map(({ card, idx }, i, arr) => {
                                            const isSelected = selectedCards.includes(idx);
                                            const rotation = (i - (arr.length - 1) / 2) * 4; 
                                            const translateY = Math.abs(i - (arr.length - 1) / 2) * 3;
                                            
                                            return (
                                                <div key={idx} className="relative transition-all duration-300 origin-bottom" 
                                                     style={{ 
                                                         zIndex: isSelected ? 50 : i,
                                                         transform: `rotate(${rotation}deg) translateY(${translateY}px)` 
                                                     }}>
                                                    <ElementCard 
                                                        type={card} 
                                                        selected={isSelected}
                                                        onClick={() => handleCardClick(idx)}
                                                    />
                                                </div>
                                            );
                                        })
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* МОДАЛКА ТОРГІВЛІ */}
                    <Modal isOpen={isTradeModalOpen} onClose={() => setTradeModalOpen(false)} title="Торгова Гільдія">
                        <div className="flex mb-4 bg-green-100 p-1 rounded-xl">
                            <button onClick={() => setTradeTab('bank')} className={`flex-1 py-2 rounded-lg font-bold text-xs uppercase ${tradeTab==='bank' ? 'bg-yellow-600 text-white shadow' : 'text-green-800'}`}>Банк (3:1)</button>
                            <button onClick={() => setTradeTab('player')} className={`flex-1 py-2 rounded-lg font-bold text-xs uppercase ${tradeTab==='player' ? 'bg-purple-700 text-white shadow' : 'text-green-800'}`}>Гравці</button>
                        </div>

                        <div className="mb-4">
                            <h4 className="text-[10px] font-bold text-green-800 uppercase mb-2">1. Віддаєте (з руки):</h4>
                            <div className="flex gap-2 min-h-[50px] p-2 bg-white border border-green-300 rounded-lg overflow-x-auto items-center">
                                {selectedCards.length > 0 ? (
                                    selectedCards.map(idx => (
                                        <div key={idx} className="text-xs font-bold px-2 py-1 bg-gray-200 rounded">{myPlayer.hand[idx]}</div>
                                    ))
                                ) : <span className="text-xs text-gray-400 italic">Оберіть карти...</span>}
                            </div>
                        </div>

                        <div className="mb-6">
                            <h4 className="text-[10px] font-bold text-green-800 uppercase mb-2">2. Отримуєте:</h4>
                            <div className="grid grid-cols-5 gap-1">
                                {Object.keys(ELEMENTS).map(el => (
                                    <button 
                                        key={el} 
                                        onClick={() => setTradeOffer(prev => ({ ...prev, want: el }))}
                                        className={`p-1 rounded border text-xs font-bold ${tradeOffer.want === el ? 'bg-green-700 text-white' : 'bg-white text-green-900'}`}
                                    >
                                        {el}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <button 
                            onClick={tradeTab === 'bank' ? executeBankTrade : createPlayerTrade}
                            className="w-full py-3 bg-green-800 text-white rounded-xl font-bold uppercase text-xs tracking-widest shadow-lg"
                        >
                            Підтвердити
                        </button>
                    </Modal>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SynthesisGame />);
    </script>
</body>
</html>
